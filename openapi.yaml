openapi: 3.0.3
info:
  title: Sunday API
  description: |
    Sunday is a RAG (Retrieval Augmented Generation) API that provides entity-based chat and document management capabilities.
    
    The API uses entity-based document storage and retrieval, allowing each entity to have its own knowledge base.
    When chatting with an entity, the system retrieves relevant documents and uses them as context for generating responses.
  version: 1.0.0
  contact:
    name: Sunday API Support
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: https://api.example.com
    description: Production server (replace with actual URL)

security:
  - bearerAuth: []

tags:
  - name: Health
    description: Health check endpoints
  - name: Chat
    description: AI chat endpoints with RAG capabilities
  - name: Documents
    description: Document management for entity knowledge bases

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the service
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                required:
                  - status
                  - message
                properties:
                  status:
                    type: string
                    example: ok
                  message:
                    type: string
                    example: Service is healthy

  /api/chat:
    post:
      tags:
        - Chat
      summary: Chat with an entity
      description: |
        Send a chat message to an AI assistant for a specific entity.
        The assistant will use documents associated with the entity as context for generating responses.
        
        The system performs vector similarity search to find relevant documents for the entity
        and includes them in the context when generating responses.
      operationId: chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              simple:
                summary: Simple chat message
                value:
                  entity_id: "acme-corp"
                  messages:
                    - role: "user"
                      text: "What does our company do?"
              multipleMessages:
                summary: Chat with message history
                value:
                  entity_id: "acme-corp"
                  messages:
                    - role: "user"
                      text: "Who is the CEO?"
                    - role: "assistant"
                      text: "The CEO is Jane Smith."
                    - role: "user"
                      text: "When did she start?"
      responses:
        '200':
          description: Chat response received
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                success:
                  summary: Successful response
                  value:
                    text: "Our company specializes in manufacturing anvils and explosives. We were founded in 1920 and have expanded to 50 countries worldwide."
                error:
                  summary: Response with error
                  value:
                    text: ""
                    error: "Failed to get AI response: connection timeout"
        '400':
          description: Bad request - missing or invalid entity_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              example:
                text: ""
                error: "entity_id is required"
        '403':
          description: Forbidden - authentication required
          content:
            text/plain:
              schema:
                type: string
                example: "Authentication required. Please provide a valid API key."

  /api/documents:
    post:
      tags:
        - Documents
      summary: Create a document
      description: |
        Create a new document and associate it with an entity.
        
        The document content will be:
        1. Embedded using Azure OpenAI embeddings
        2. Stored in the vector database
        3. Linked to the specified entity
        
        If the entity doesn't exist, it will be created automatically.
      operationId: createDocument
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDocumentRequest'
            examples:
              company:
                summary: Company information document
                value:
                  entity_id: "acme-corp"
                  content: "Acme Corporation was founded in 1920. We specialize in manufacturing anvils and explosives. Our headquarters is located in Phoenix, Arizona."
              person:
                summary: Person information document
                value:
                  entity_id: "acme-corp"
                  content: "Our CEO is Jane Smith. She has been leading the company since 2015. Under her leadership, we expanded to 50 countries worldwide."
      responses:
        '201':
          description: Document created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateDocumentResponse'
              example:
                document_id: "550e8400-e29b-41d4-a716-446655440000"
                entity_id: "acme-corp"
                message: "Document created and embedded successfully"
        '400':
          description: Bad request - missing or invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingEntityId:
                  summary: Missing entity_id
                  value:
                    error: "entity_id is required"
                emptyContent:
                  summary: Empty content
                  value:
                    error: "content cannot be empty"
        '403':
          description: Forbidden - authentication required
          content:
            text/plain:
              schema:
                type: string
                example: "Authentication required. Please provide a valid API key."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                processingError:
                  summary: Failed to process entity
                  value:
                    error: "Failed to process entity: database connection error"
                embeddingError:
                  summary: Failed to create document
                  value:
                    error: "Failed to create document: embedding generation failed"
        '503':
          description: Service unavailable - AI models not configured
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "AI models not available for embedding generation"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: |
        API key authentication using Bearer token.
        
        Include your API key in the Authorization header:
        `Authorization: Bearer your-api-key-here`
        
        Note: The /health endpoint does not require authentication.

  schemas:
    ChatRequest:
      type: object
      required:
        - entity_id
        - messages
      properties:
        entity_id:
          type: string
          description: |
            The unique identifier for the entity (e.g., company, user, project).
            Documents and context are scoped to this entity.
          minLength: 1
          example: "acme-corp"
        messages:
          type: array
          description: |
            Array of messages in the conversation.
            The system will use the latest user message and include conversation history for context.
          minItems: 1
          items:
            $ref: '#/components/schemas/MessageContent'

    MessageContent:
      type: object
      properties:
        role:
          type: string
          description: The role of the message sender
          enum:
            - user
            - assistant
          example: "user"
        text:
          type: string
          description: The text content of the message
          example: "What does our company do?"

    ChatResponse:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          description: The AI-generated response text
          example: "Based on the documents, Acme Corporation specializes in manufacturing anvils and explosives."
        error:
          type: string
          description: Error message if the request failed
          nullable: true
          example: null

    CreateDocumentRequest:
      type: object
      required:
        - entity_id
        - content
      properties:
        entity_id:
          type: string
          description: |
            The unique identifier for the entity to associate this document with.
            If the entity doesn't exist, it will be created automatically.
          minLength: 1
          example: "acme-corp"
        content:
          type: string
          description: The text content of the document to be embedded and stored
          minLength: 1
          example: "Acme Corporation was founded in 1920. We specialize in manufacturing anvils and explosives."

    CreateDocumentResponse:
      type: object
      required:
        - document_id
        - entity_id
        - message
      properties:
        document_id:
          type: string
          format: uuid
          description: The unique identifier of the created document
          example: "550e8400-e29b-41d4-a716-446655440000"
        entity_id:
          type: string
          format: uuid
          description: The unique identifier of the entity
          example: "660e8400-e29b-41d4-a716-446655440001"
        message:
          type: string
          description: Success message
          example: "Document created and embedded successfully"

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message describing what went wrong
          example: "entity_id is required"
